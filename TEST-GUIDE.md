# RAG 测试指南

## 🧪 测试概览

我们提供了完整的测试套件来验证 RAG 功能是否正常工作。

## 📋 测试类型

### 1. 单元测试 `test:rag-unit`

**测试范围：**
- ✅ EmbeddingModel 向量化功能
- ✅ DocumentProcessor 文档处理
- ✅ VectorStore 向量存储和检索
- ✅ RAGRetriever 完整流程
- ✅ 相似度计算和排序

**运行命令：**
```bash
pnpm run test:rag-unit
```

**测试项目（10 个）：**

1. **EmbeddingModel - 单文本向量化**
   - 验证能否将文本转换为 1536 维向量
   - 验证向量元素类型是否正确

2. **EmbeddingModel - 批量向量化**
   - 验证批量处理功能
   - 验证返回向量数量和维度

3. **EmbeddingModel - 余弦相似度计算**
   - 验证相同向量相似度为 1.0
   - 验证正交向量相似度为 0.0

4. **DocumentProcessor - 文档加载**
   - 验证能否加载文件
   - 验证文档内容和元数据

5. **DocumentProcessor - 文档分块**
   - 验证长文档能否正确分块
   - 验证分块元数据（索引、总数）

6. **VectorStore - 添加和检索文档**
   - 验证文档添加功能
   - 验证检索功能和相关性

7. **VectorStore - 保存和加载**
   - 验证持久化功能
   - 验证加载后数据完整性

8. **RAGRetriever - 完整检索流程**
   - 验证端到端检索
   - 验证上下文格式化

9. **RAGRetriever - 文件索引功能**
   - 验证目录索引
   - 验证多文件处理

10. **相似度排序验证**
    - 验证检索结果按相似度排序
    - 验证最相关文档排在首位

### 2. 功能示例 `test:rag`

**测试范围：**
- 基础 RAG 使用流程
- 手动添加文档
- 启用/禁用 RAG 对比

**运行命令：**
```bash
pnpm run test:rag
```

### 3. 文件索引示例 `test:rag-file`

**测试范围：**
- 自动创建测试文档
- 目录索引
- 向量存储持久化

**运行命令：**
```bash
pnpm run test:rag-file
```

### 4. 完整集成示例 `test:complete`

**测试范围：**
- Agent + RAG 完整集成
- 知识库构建
- 多问题测试

**运行命令：**
```bash
pnpm run test:complete
```

## 🚀 快速开始

### 步骤 1: 配置环境

确保 `.env` 文件存在并包含：
```env
OPENAI_API_KEY=your_api_key_here
```

### 步骤 2: 运行单元测试

```bash
pnpm run test:rag-unit
```

**预期输出：**
```
=================================================================
🧪 RAG 功能测试套件
=================================================================

📋 测试: EmbeddingModel - 单文本向量化
------------------------------------------------------------
✅ 通过: 成功生成 1536 维向量

📋 测试: EmbeddingModel - 批量向量化
------------------------------------------------------------
✅ 通过: 成功生成 3 个向量

... (更多测试)

=================================================================
📊 测试总结
=================================================================
总测试数: 10
✅ 通过: 10
❌ 失败: 0
成功率: 100.0%
=================================================================

🎉 所有测试通过！RAG 功能正常！
```

### 步骤 3: 运行功能示例

```bash
# 基础示例
pnpm run test:rag

# 文件索引示例
pnpm run test:rag-file

# 完整集成示例
pnpm run test:complete
```

## 📊 测试报告解读

### 成功标志

- ✅ 所有测试项显示绿色 ✅
- ✅ 成功率 100%
- ✅ 没有错误信息
- ✅ 检索结果相关性正确

### 常见问题

#### 问题 1: `OPENAI_API_KEY 未设置`

**原因：** 环境变量未配置

**解决：**
```bash
# 创建 .env 文件
echo "OPENAI_API_KEY=你的密钥" > .env
```

#### 问题 2: 向量维度错误

**原因：** 使用了错误的嵌入模型

**解决：** 确保使用 `text-embedding-3-small` (1536 维)

#### 问题 3: 检索结果为空

**原因：** 
- 文档未正确索引
- 查询与文档完全不相关

**解决：**
- 检查文档内容
- 增加 topK 值
- 使用更相关的查询

#### 问题 4: 网络超时

**原因：** OpenAI API 调用超时

**解决：**
- 检查网络连接
- 使用代理（如需要）
- 稍后重试

## 🔍 详细测试说明

### 单元测试架构

```typescript
// 测试工具函数
testStart(name)    // 开始测试
testPass(message)  // 测试通过
testFail(message)  // 测试失败

// 测试流程
try {
    // 1. 准备测试数据
    // 2. 执行功能
    // 3. 验证结果
    // 4. 标记通过/失败
} catch (error) {
    testFail("错误信息", error);
}
```

### 测试覆盖范围

| 模块 | 覆盖率 | 测试数量 |
|------|--------|---------|
| EmbeddingModel | 100% | 3 |
| DocumentProcessor | 100% | 2 |
| VectorStore | 100% | 2 |
| RAGRetriever | 100% | 2 |
| 集成测试 | 100% | 1 |

## 🎯 最佳实践

### 1. 运行测试前

- ✅ 确保环境变量已配置
- ✅ 确保网络连接正常
- ✅ 确保有足够的 OpenAI API 配额

### 2. 测试失败时

1. 查看错误信息
2. 检查环境配置
3. 验证输入数据
4. 查看日志输出
5. 参考本文档的常见问题

### 3. 添加新测试

```typescript
// 在 test-rag.ts 中添加
testStart("新测试名称");
try {
    // 测试代码
    const result = yourFunction();
    
    if (result === expected) {
        testPass("测试通过的消息");
    } else {
        testFail("测试失败的消息");
    }
} catch (error) {
    testFail("错误消息", error);
}
```

## 📈 性能基准

### 预期性能指标

| 操作 | 预期时间 | 说明 |
|------|---------|------|
| 单文本向量化 | < 1s | OpenAI API 调用 |
| 批量向量化（3 个） | < 2s | 批量处理 |
| 文档加载 | < 100ms | 本地文件 I/O |
| 文档分块 | < 50ms | 纯计算 |
| 向量检索 | < 1s | 包含向量化 |
| 保存向量存储 | < 500ms | JSON 序列化 |
| 加载向量存储 | < 500ms | JSON 反序列化 |

### 完整测试套件运行时间

- **单元测试**: 约 10-15 秒
- **功能示例**: 约 20-30 秒
- **完整集成**: 约 30-40 秒

## 🔧 调试技巧

### 1. 启用详细日志

测试文件已包含详细日志输出，可以看到：
- 每个测试的执行状态
- 具体的错误信息
- 相似度分数
- 文档内容预览

### 2. 单独运行测试

修改 `test-rag.ts`，注释掉不需要的测试：

```typescript
// 只运行第 8 个测试
// testStart("测试 1");
// ... 其他测试
testStart("测试 8: RAGRetriever - 完整流程");
// ... 测试代码
```

### 3. 查看中间结果

在测试代码中添加 `console.log`：

```typescript
console.log("向量:", vector.slice(0, 5)); // 查看前 5 个元素
console.log("文档:", JSON.stringify(doc, null, 2));
console.log("相似度:", results.map(r => r.score));
```

## 📚 参考资料

- [RAG-GUIDE.md](./RAG-GUIDE.md) - 完整使用指南
- [QUICK-START.md](./QUICK-START.md) - 快速上手
- [RAG-ARCHITECTURE.md](./RAG-ARCHITECTURE.md) - 架构文档

## ✅ 检查清单

运行测试前，请确认：

- [ ] 已安装依赖 (`pnpm install`)
- [ ] 已配置 `.env` 文件
- [ ] `OPENAI_API_KEY` 有效
- [ ] 网络连接正常
- [ ] 磁盘空间充足（保存向量文件）

运行测试后，应该看到：

- [ ] 所有测试显示 ✅
- [ ] 成功率 100%
- [ ] 无错误信息
- [ ] 相似度分数合理（> 0.5）

## 🎉 总结

通过运行这些测试，你可以：

1. ✅ 验证 RAG 核心功能正常
2. ✅ 确认各个模块正确工作
3. ✅ 了解系统性能表现
4. ✅ 发现潜在问题
5. ✅ 确保代码质量

**现在就运行测试吧！**

```bash
pnpm run test:rag-unit
```
